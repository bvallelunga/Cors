function ListNode(t){this.item=t}function List(){}function Vector(t,e,i){this.x=t,this.y=e,this.z=i?i:0,this.w=0}function ResourceMonitor(){return ResourceMonitor.prototype.instance?ResourceMonitor.prototype.instance:(ResourceMonitor.prototype.instance=this,this.loadList=new List,this.totalItems=0,void(this.leftToLoad=0))}function TextureManager(){return TextureManager.prototype.instance?TextureManager.prototype.instance:(TextureManager.prototype.instance=this,this.imgs=new Array,void(this.waitingList=new List))}function SoundManager(){return SoundManager.prototype.instance?SoundManager.prototype.instance:(SoundManager.prototype.instance=this,this.snds=new Array,void(this.muted=!1))}function toggleSounds(t){t.muted=Sounds.muted}function FontManager(){return FontManager.prototype.instance?FontManager.prototype.instance:(FontManager.prototype.instance=this,void(this.fonts=new Array))}function FileManager(){return FileManager.prototype.instance?FileManager.prototype.instance:(FileManager.prototype.instance=this,void(this.files=new Array))}function xmlRequest(){var t;try{t=new XMLHttpRequest}catch(e){try{t=new ActiveXObject("Msxml2.XMLHTTP")}catch(e){try{t=new ActiveXObject("Microsoft.XMLHTTP")}catch(e){return alert("Your browser does not support AJAX!"),!1}}}return t}function initGL(t){try{ctx.viewportWidth=t.width,ctx.viewportHeight=t.height,initBuffers(ctx),fragShader=compileShader(ctx,defaultFragSrc),vertShader=compileShader(ctx,defaultVertSrc),shaderProgram=createShaderProgram(),setupSpriteShader(shaderProgram),spriteShader=shaderProgram,colorBuffer=createRenderTarget(ctx,t.width,t.height),stateBuffer=createRenderTarget(ctx,t.width,t.height),ctx.clearColor(0,0,0,1),ctx.blendFunc(ctx.SRC_ALPHA,ctx.ONE_MINUS_SRC_ALPHA),ctx.enable(ctx.BLEND)}catch(e){}}function setMatrixUniforms(t){ctx.uniformMatrix4fv(t.pMatrixUniform,!1,pMatrix),ctx.uniformMatrix4fv(t.mvMatrixUniform,!1,mvMatrix)}function getShaderSrc(t){if(!use2D){var e=document.getElementById(t);if(!e)return null;for(var i="",r=e.firstChild;r;)3==r.nodeType&&(i+=r.textContent),r=r.nextSibling;var n;if("x-shader/x-fragment"==e.type)n="frag";else{if("x-shader/x-vertex"!=e.type)return null;n="vert"}return{code:i,type:n}}return null}function compileShader(t,e){if(!use2D){if(!e)return println("no src"),null;var i;if("frag"==e.type)i=t.createShader(t.FRAGMENT_SHADER);else{if("vert"!=e.type)return println("no type: "+e.type),null;i=t.createShader(t.VERTEX_SHADER)}return t.shaderSource(i,e.code),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS)?i:(alert(t.getShaderInfoLog(i)),null)}return null}function createShaderProgram(t,e){if(!use2D){var i,r;i=t?compileShader(ctx,t):fragShader,r=e?compileShader(ctx,e):vertShader;var n=ctx.createProgram();return ctx.attachShader(n,r),ctx.attachShader(n,i),ctx.linkProgram(n),ctx.getProgramParameter(n,ctx.LINK_STATUS)||alert("Could not initiate shaders"),n.vertexPositionAttribute=ctx.getAttribLocation(n,"aVertexPosition"),ctx.bindAttribLocation(n,0,"aVertexPosition"),ctx.enableVertexAttribArray(n.vertexPositionAttribute),n.textureCoordAttribute=ctx.getAttribLocation(n,"aTextureCoord"),ctx.enableVertexAttribArray(n.textureCoordAttribute),n.pMatrixUniform=ctx.getUniformLocation(n,"uPMatrix"),n.mvMatrixUniform=ctx.getUniformLocation(n,"uMVMatrix"),n}return null}function setupSpriteShader(t){use2D||(t.vertexPositionAttribute=ctx.getAttribLocation(t,"aVertexPosition"),ctx.enableVertexAttribArray(t.vertexPositionAttribute),t.textureCoordAttribute=ctx.getAttribLocation(t,"aTextureCoord"),ctx.enableVertexAttribArray(t.textureCoordAttribute),t.pMatrixUniform=ctx.getUniformLocation(t,"uPMatrix"),t.mvMatrixUniform=ctx.getUniformLocation(t,"uMVMatrix"),t.frameOffset=ctx.getUniformLocation(t,"frameOffset"),t.frameDims=ctx.getUniformLocation(t,"frameDims"),t.tiles=ctx.getUniformLocation(t,"tiles"),t.scroll=ctx.getUniformLocation(t,"scroll"),t.multColor=ctx.getUniformLocation(t,"multColor"),t.alpha=ctx.getUniformLocation(t,"alpha"))}function initBuffers(t){spriteVPB=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,spriteVPB);var e=[0,-1,0,1,-1,0,1,0,0,0,0,0];t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),t.STATIC_DRAW),spriteVPB.itemSize=3,spriteVPB.numItems=4,spriteVTB=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,spriteVTB);var i=[0,0,1,0,1,1,0,1];t.bufferData(t.ARRAY_BUFFER,new Float32Array(i),t.STATIC_DRAW),spriteVTB.itemSize=2,spriteVTB.numItems=4,spriteVIB=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,spriteVIB);var r=[0,1,2,0,2,3];t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(r),t.STATIC_DRAW),spriteVIB.itemSize=1,spriteVIB.numItems=6}function createRenderTarget(t,e,i){var r=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,r),r.width=e,r.height=i;var n=t.createTexture();t.bindTexture(t.TEXTURE_2D,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e,i,0,t.RGBA,t.UNSIGNED_BYTE,null);var o=t.createRenderbuffer();return t.bindRenderbuffer(t.RENDERBUFFER,o),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,e,i),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,n,0),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,o),r.texture=n,t.bindTexture(t.TEXTURE_2D,null),t.bindRenderbuffer(t.RENDERBUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,null),r}function PostFXChain(){this.effects=new List}function PostFX(){}function Sprite(){this.children=new List,this.image=new Image,this.pos=new Vector(0,0,0),this.index=0,this.blendFunction={a:"SRC_ALPHA",b:"ONE_MINUS_SRC_ALPHA"},this.multColor=new Vector(1,1,1),this.animations=new Array}function sortByZ(t,e){return e.index-t.index}function BBox(t,e,i,r,n,o){this.pos=new Vector(t,e,i),this.dims=new Vector(r,n,o),this.offsets=new Vector(0,0,0),this.vel=new Vector(0,0,0),this.solid=!1}function BRect(t,e,i,r){this.pos=new Vector(t,e,0),this.dims=new Vector(i,r,0),this.offsets=new Vector(0,0,0),this.solid=!1}function CollisionGrid(t,e,i,r,n,o){this.x=t,this.z=e,this.width=i,this.depth=r,this.cols=n,this.rows=o,this.size=n*o,this.cells=new Array;for(var s=0;s<this.size;s++)this.cells.push(new List);this.visible=!1}function Input(){this.printKey=!1,this.keys=new Array,this.bools=new Array,this.funcs=new Array,this.repeats=new Array,this.mouse=new Vector(0,0,0),this.shift=!1,this.lBtn=!1,this.mBtn=!1,this.rBtn=!1,this.lBtnFuncs=new Array,this.mBtnFuncs=new Array,this.rBtnFuncs=new Array,this.mdListens=new Array,this.muListens=new Array,this.mmListens=new Array,this.keyListens=new Array}function GUI(t){this.init(),this.input=t,t.addMouseDownListener(this),t.addMouseUpListener(this),t.addMouseMoveListener(this),t.addKeyboardListener(this)}function GUIElement(){}function TextBox(t){this.init(),void 0!=t&&(this.text=t),this.bufferColor=this.color,this.bbox=new BRect(0,0,1,1),this.buffer=document.createElement("canvas"),this.bctx=this.buffer.getContext("2d")}function Button(t){this.init(),this.func=t,this.bbox=new BRect(0,0,1,1),this.color="#ffffff",this.upColor="#ccffcc",this.downColor="#ccccff",this.drawColor=this.color,this.drawBG=!0}function TextButton(t,e){this.init(),this.label=new TextBox(t),this.label.minWidth=0,this.addChild(this.label),this.width=this.label.getDims().x,this.height=this.label.getDims().y,this.bbox=new BRect(0,0,this.width,this.height),this.func=e,this.drawBG=!1,this.labelColor="#000000",this.labelUpColor="#000000",this.labelDownColor="#000000",this.labelDrawColor=this.label.color}function initGame(t){if(canvas=document.getElementById(t),canvas.setAttribute("tabindex","0"),canvas.radius=Math.sqrt(canvas.width*canvas.width+canvas.height*canvas.height)/2,canvas.pos=[canvas.width/2,canvas.height/2,0],aspectRatio=canvas.width/canvas.height,canvas.initialWidth=canvas.width,canvas.initialHeight=canvas.height,canvas.scaleX=canvas.offsetWidth/canvas.width,canvas.scaleY=canvas.offsetHeight/canvas.height,canvas.focus(),display=document.getElementById("display"),void 0!=display&&(display.style.width=canvas.width,display.style.height=canvas.height,display.style.overflow="hidden",display.style.position="relative",display.style.backgroundColor=document.body.bgColor,display.style.webkitTouchCallout="none",display.style.webkitUserSelect="none",display.style.khtmlUserSelect="none",display.style.MozUserSelect="none",display.style.msUserSelect="none",display.style.UserSelect="none"),brineConsole=document.getElementById("console"),canvas.getContext){try{use2D||(ctx=canvas.getContext("experimental-webgl",{alpha:!0}))}catch(e){}ctx?(initGL(canvas),Textures.create()):(ctx=canvas.getContext("2d"),use2D=!0),rewriteCTXFunctions(),world.init(),gInput.addFunc(192,toggleConsole,!1),gInput.addFunc(45,togglePrintKey),gameLoop=requestAnimationFrame(update)}canvas.addEventListener("keydown",canvasHandleKeyDown,!1),canvas.addEventListener("keyup",canvasHandleKeyUp,!1),canvas.addEventListener("keypress",canvasHandleKeyPress,!1),document.addEventListener("mousemove",canvasMouseMove,!1),canvas.addEventListener("mousedown",canvasMouseDown,!1),document.addEventListener("mouseup",canvasMouseUp,!1),allowContextMenu||(canvas.oncontextmenu=function(){return!1})}function switchContext(){use2D?setCookie("use2D",!1,100):setCookie("use2D",!0,100)}function canvasMouseMove(t){t||(t=window.event),useStates&&States.current().input.mouseMove(t),gInput.mouseMove(t)}function canvasMouseDown(t){t||(t=window.event),canvas.focus(),useStates&&States.current().input.mouseDown(t),gInput.mouseDown(t)}function canvasMouseUp(t){t||(t=window.event),useStates&&States.current().input.mouseUp(t),gInput.mouseUp(t)}function canvasHandleKeyDown(t){t.keyCode;useStates&&States.current().input.handleKeyDown(t),gInput.handleKeyDown(t)}function canvasHandleKeyUp(t){t.keyCode;useStates&&States.current().input.handleKeyUp(t),gInput.handleKeyUp(t)}function canvasHandleKeyPress(t){t.which;useStates&&States.current().input.handleKeyPress(t),gInput.handleKeyPress(t)}function contextMenu(){return println("context"),!1}function togglePrintKey(){gInput.printKey=gInput.printKey?!1:!0}function update(t){canvas.scaleX=canvas.offsetWidth/canvas.width,canvas.scaleY=canvas.offsetHeight/canvas.height,oldTime||(oldTime=t);var e=(t-oldTime)/MSPF;oldTime=t,e=Math.min(1,e),useStates&&States.update(e),world.update(e),draw(),gameLoop=requestAnimationFrame(update)}function draw(){if(use2D)ctx.clearRect(0,0,canvas.width,canvas.height),ctx.fillStyle=rgb(clearColor),ctx.globalAlpha=clearColor[3],ctx.fillRect(0,0,canvas.width,canvas.height);else{ctx.setBuffer(null),ctx.viewport(0,0,ctx.viewportWidth,ctx.viewportHeight);var t=clearColor[3];ctx.clearColor(clearColor[0]*t,clearColor[1]*t,clearColor[2]*t,t),ctx.clear(ctx.COLOR_BUFFER_BIT|ctx.DEPTH_BUFFER_BIT),ctx.setBuffer(colorBuffer),ctx.viewport(0,0,ctx.viewportWidth,ctx.viewportHeight),ctx.clearColor(0,0,0,0),ctx.clear(ctx.COLOR_BUFFER_BIT|ctx.DEPTH_BUFFER_BIT)}if(mat4.ortho(-0,1*aspectRatio,-1,0,-1,1,pMatrix),mat4.identity(mvMatrix),useStates&&States.draw(ctx),world.transform(ctx),world.draw(ctx),world.unTransform(ctx),use2D||(ctx.clearColor(0,0,0,0),effects.apply(ctx,colorBuffer),ctx.useProgram(shaderProgram),ctx.bindTexTo(colorBuffer.texture,shaderProgram.samplerUniform),ctx.uniform1f(shaderProgram.alpha,1),ctx.setBuffer(null),ctx.drawScreenBuffer(shaderProgram)),showConsole)if(use2D){ctx.fillStyle="#ffffff",ctx.globalAlpha=.25,ctx.fillRect(0,0,canvas.width,canvas.height),ctx.globalAlpha=1,ctx.fillStyle="#000000",ctx.shadowColor="#ffffff";for(var e=18,i=0,r=log.head;null!==r;r=r.link){var n=r.item;ctx.font=e+"px Arial",ctx.fillText(n,5,canvas.height-(log.length-i)*e),i++}ctx.shadowBlur=0}else{if(brineConsole=document.getElementById("console"),null!=brineConsole&&void 0!=brineConsole){for(var o="",r=log.head;null!==r;r=r.link)o=r.item+"<br/>"+o;brineConsole.innerHTML=o}brineConsole.style.visibility="visible"}else null==brineConsole||void 0==brineConsole||use2D||(brineConsole.innerHTML="",brineConsole.style.visibility="hidden")}function rewriteCTXFunctions(){var t=["moz","webkit","o","ms"];canvas.matchScreenRes=!1,canvas.enterFullScreen=function(e){if(exists(this.requestFullScreen))this.requestFullScreen();else for(var i in t)i=t[i],exists(this[i+"RequestFullScreen"])&&this[i+"RequestFullScreen"]();this.matchScreenRes=e},canvas.exitFullScreen=function(){if(exists(this.cancelFullScreen))this.cancelFullScreen();else for(var e in t)e=t[e],exists(canvas[e+"CancelFullScreen"])&&canvas[e+"CancelFullScreen"]()},canvas.onFullScreenChange=function(){document.webkitIsFullScreen||document.mozFullScreen?(console.log("enter full"),canvas.matchScreenRes&&(canvas.width=screen.width,canvas.height=screen.height),canvas.style.width=screen.width+"px",canvas.style.height=screen.height+"px"):(console.log("exit full"),exists(canvas.initialWidth)&&(canvas.width=canvas.initialWidth),exists(canvas.initialHeight)&&(canvas.height=canvas.initialHeight),canvas.style.width="",canvas.style.height=""),aspectRatio=canvas.width/canvas.height,ctx.viewportWidth=canvas.width,ctx.viewportHeight=canvas.height},document.addEventListener("fullscreenchange",canvas.onFullScreenChange,!1),document.addEventListener("mozfullscreenchange",canvas.onFullScreenChange,!1),document.addEventListener("webkitfullscreenchange",canvas.onFullScreenChange,!1);var e=ctx.constructor.prototype,i=mat4.create();mat4.identity(i),ctx.save=function(){var t=mat4.create();mat4.multiply(mvMatrix,i,t),ctx.matrix=t,matrixStack.push_back(t),use2D&&e.save.call(ctx)},ctx.restore=function(){mvMatrix=matrixStack.pop_back(),use2D&&e.restore.call(ctx)},ctx.curDrawPos=new Vector(0,0,0),ctx.moveTo=function(t,i){return use2D?e.moveTo.call(this,t,i):(ctx.curDrawPos.x=t,void(ctx.curDrawPos.y=i))};var r=new Sprite;r.image=Textures.load(brinePixelData),ctx.lineSprite=r,ctx.glLineWidth=1,ctx.lineTo=function(t,i){if(use2D)return e.lineTo.call(this,t,i);var r=t-this.curDrawPos.x,n=i-this.curDrawPos.y,o=Math.sqrt(r*r+n*n),s=Math.atan2(n,r);this.lineSprite.x=this.curDrawPos.x,this.lineSprite.y=this.curDrawPos.y,this.lineSprite.rotation=s,this.lineSprite.width=o,this.lineSprite.height=this.glLineWidth,this.lineSprite.yoffset=-this.lineSprite.height/2,this.lineSprite.transform(this),this.lineSprite.draw(this),this.lineSprite.unTransform(this),this.curDrawPos.x=t,this.curDrawPos.y=i},ctx.getMatrix=function(){return this.matrix},ctx.scale=function(t,i){return t=0==t?1e-7:t,i=0==i?1e-7:i,mat4.scale(mvMatrix,[t,i,1]),use2D?e.scale.call(this,t,i):void 0},ctx.rotate=function(t){return mat4.rotateZ(mvMatrix,-t),use2D?e.rotate.call(this,t):void 0},ctx.translate=function(t,i){return mat4.translate(mvMatrix,[t*aspectRatio/canvas.width,-i/canvas.height,0]),use2D?e.translate.call(this,t,i):void 0},ctx.transform=function(t,i,r,n,o,s){return use2D?e.transform.call(this,t,i,r,n,o,s):void 0},ctx.setTransform=function(t,i,r,n,o,s){return use2D?e.setTransform.call(this,t,i,r,n,o,s):void 0},use2D?(ctx.spriteBuffer=document.createElement("canvas"),ctx.spriteBCTX=ctx.spriteBuffer.getContext("2d")):(ctx.setBuffer=function(t){this.bindFramebuffer(this.FRAMEBUFFER,t)},ctx.bindTexTo=function(t,e,i){i=i?i:0,this.activeTexture(this.TEXTURE0+i),this.bindTexture(this.TEXTURE_2D,t),this.uniform1i(e,i)},ctx.drawScreenBuffer=function(t,e){mat4.identity(mvMatrix),mat4.scale(mvMatrix,[aspectRatio,1,1]),this.viewport(0,0,this.viewportWidth,this.viewportHeight),e&&this.clear(this.COLOR_BUFFER_BIT),this.blendFunc(this.ONE,this.ONE_MINUS_SRC_ALPHA),this.bindBuffer(this.ARRAY_BUFFER,spriteVPB),this.vertexAttribPointer(t.vertexPositionAttribute,spriteVPB.itemSize,this.FLOAT,!1,0,0),this.bindBuffer(this.ARRAY_BUFFER,spriteVTB),this.vertexAttribPointer(t.textureCoordAttribute,spriteVTB.itemSize,this.FLOAT,!1,0,0),this.bindBuffer(this.ELEMENT_ARRAY_BUFFER,spriteVIB),setMatrixUniforms(t),this.drawElements(this.TRIANGLES,spriteVIB.numItems,this.UNSIGNED_SHORT,0),mat4.identity(mvMatrix)}),ctx.alpha=1;var n=new Array;n.push([0,0,0]),n.push([0,0,0]),n.push([0,0,0]),n.push([0,0,0]),ctx.drawSprite=function(t,e){var i=t.width,r=t.height,n=(i*t.scaleX,r*t.scaleY,t.xoffset),o=t.yoffset,s=t.image;e=e?Math.floor(e):0;var a=t.frameWidth>0?t.frameWidth:s.width,c=t.frameHeight>0?t.frameHeight:s.height,u=t.multColor,h=Math.max(0,ctx.alpha),l=t.blendMode;ctx.globalAlpha=h,ctx.globalCompositeOperation=l;var p=spriteShader;void 0!=t.image.texture&&(o=-o,ctx.blendFuncSeparate(ctx[t.blendFunction.a],ctx[t.blendFunction.b],ctx.ONE,ctx.ONE_MINUS_SRC_ALPHA),mat4.translate(mvMatrix,[n*aspectRatio/canvas.width,o/canvas.height,0]),i=Math.max(1e-7,i),r=Math.max(1e-7,r),mat4.scale(mvMatrix,[i*aspectRatio/canvas.width,r/canvas.height,1]),null!=t.shader&&void 0!=t.shader,ctx.useProgram(p),ctx.bindBuffer(ctx.ARRAY_BUFFER,spriteVPB),ctx.vertexAttribPointer(p.vertexPositionAttribute,spriteVPB.itemSize,ctx.FLOAT,!1,0,0),ctx.bindBuffer(ctx.ARRAY_BUFFER,spriteVTB),ctx.vertexAttribPointer(p.textureCoordAttribute,spriteVTB.itemSize,ctx.FLOAT,!1,0,0),ctx.activeTexture(ctx.TEXTURE0),ctx.bindTexture(ctx.TEXTURE_2D,t.image.texture),ctx.uniform1i(p.samplerUniform,0),ctx.uniform3f(p.multColor,u.r,u.g,u.b),ctx.uniform1f(p.alpha,h));var f=t.tilesX,d=t.tilesY,m=void 0!=f&&void 0!=d,x=Math.min(Math.max(0,t.sliceX),a),y=Math.min(Math.max(0,t.sliceY),c),v=t.sliceWidth?Math.max(0,t.sliceWidth):t.sliceWidth,b=t.sliceHeight?Math.max(0,t.sliceHeight):t.sliceHeight,w=t.scrollX%(i/f),g=t.scrollY%(r/d),M=void 0!=w&&void 0!=g&&(0!=w||0!=g),T=e%(s.width/a)*a,B=Math.floor(e/(s.width/a))*c;if(a-=x,c-=y,a=v?Math.min(a,v):a,c=b?Math.min(c,b):c,T+=x,B+=y,use2D){var S=1/f,A=1/d;if(M){w/=S,g/=A,w%=i,g%=r,g=-g,0>w&&(w=i+w),0>g&&(g=r+g),adscrollX=w/i*a,adscrollY=g/r*c;var R=a-adscrollX,C=c-adscrollY,L=a-R,F=C,E=L,D=c-C,I=R,U=D;this.spriteBuffer.width=i,this.spriteBuffer.height=r,R>0&&C>0&&this.spriteBCTX.drawImage(s,T+adscrollX,B+adscrollY,R,C,0,0,R/a*i,C/c*r),L>0&&F>0&&this.spriteBCTX.drawImage(s,T,B+adscrollY,L,F,0+(i-w),0,L/a*i,F/c*r),E>0&&D>0&&this.spriteBCTX.drawImage(s,T,B,E,D,0+(i-w),0+(r-g),E/a*i,D/c*r),I>0&&U>0&&this.spriteBCTX.drawImage(s,T+adscrollX,B,I,U,0,0+(r-g),I/a*i,U/c*r),s=this.spriteBuffer,T=0,B=0,a=i,c=r}for(var P=0,k=0,V=0;f>V;V++){for(var _=0;d>_;_++)this.drawImage(s,T,B,a,c,n+P,o+k,i*S,r*A),k+=r*A;k=0,P+=i*S}}else ctx.useProgram(p),ctx.uniform2f(p.frameOffset,T/s.width,B/s.height),ctx.uniform2f(p.frameDims,a/s.width,c/s.height);use2D||(m&&ctx.uniform2f(p.tiles,t.tilesX,t.tilesY),M&&ctx.uniform2f(p.scroll,w/i,g/r)),void 0!=t.image.texture&&(ctx.bindBuffer(ctx.ELEMENT_ARRAY_BUFFER,spriteVIB),setMatrixUniforms(p),ctx.drawElements(ctx.TRIANGLES,spriteVIB.numItems,ctx.UNSIGNED_SHORT,0),mat4.scale(mvMatrix,[1/(i*aspectRatio/canvas.width),1/(r/canvas.height),1]),mat4.translate(mvMatrix,[-n*aspectRatio/canvas.width,-o/canvas.height,0]),ctx.uniform2f(p.frameOffset,0,0),ctx.uniform2f(p.frameDims,1,1),ctx.uniform2f(p.tiles,1,1),ctx.uniform2f(p.scroll,0,0),ctx.uniform3f(p.multColor,1,1,1)),ctx.globalAlpha=1,ctx.globalCompositeOperation="source-over"}}function toggleConsole(){showConsole=showConsole?!1:!0}function print(t){log.push(t),log.length>25&&log.remove(log.head.item)}function println(t){print(t+"\n")}function DTR(t){return t*Math.PI/180}function RTD(t){return 180*t/Math.PI}function rgb(t){return"#"+rgbComp(t[0])+rgbComp(t[1])+rgbComp(t[2])}function rgbComp(t){var e=Math.round(255*t).toString(16);return(e.length<2?"0":"")+e}function exists(t){return"undefined"!=typeof t&&null!=t}function setCookie(t,e,i){var r=new Date;r.setDate(r.getDate()+i);var n=escape(e)+(null==i?"":"; expires="+r.toUTCString());document.cookie=t+"="+n}function getCookie(t){for(var e=document.cookie.split("; "),i=0;i<e.length;i++){var r=e[i].split("=");if(r[0]==t)return unescape(r[1])}return!1}function createGameCanvas(t,e){var i=document.createElement("canvas");return i.width=t,i.height=e,i.innerHTML='<span style="font: white;">Your browser doesn\'t support HTML 5 Canvas.<br />You should probably switch to something a little more forward thinking.</span>',i}!function(t,e){"object"==typeof exports?module.exports=e(global):"function"==typeof define&&define.amd?define([],function(){return e(t)}):e(t)}(this,function(t){function e(t){return n=t}function i(){return n="undefined"!=typeof Float32Array?Float32Array:Array}var r={};!function(){if("undefined"!=typeof Float32Array){var t=new Float32Array(1),e=new Int32Array(t.buffer);r.invsqrt=function(i){t[0]=i,e[0]=1597463007-(e[0]>>1);var r=t[0];return r*(1.5-.5*i*r*r)}}else r.invsqrt=function(t){return 1/Math.sqrt(t)}}();var n=null;i();var o={create:function(t){var e=new n(3);return t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):e[0]=e[1]=e[2]=0,e},createFrom:function(t,e,i){var r=new n(3);return r[0]=t,r[1]=e,r[2]=i,r},set:function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},equal:function(t,e){return t===e||1e-6>Math.abs(t[0]-e[0])&&1e-6>Math.abs(t[1]-e[1])&&1e-6>Math.abs(t[2]-e[2])},add:function(t,e,i){return i&&t!==i?(i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i):(t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t)},subtract:function(t,e,i){return i&&t!==i?(i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i):(t[0]-=e[0],t[1]-=e[1],t[2]-=e[2],t)},multiply:function(t,e,i){return i&&t!==i?(i[0]=t[0]*e[0],i[1]=t[1]*e[1],i[2]=t[2]*e[2],i):(t[0]*=e[0],t[1]*=e[1],t[2]*=e[2],t)},negate:function(t,e){return e||(e=t),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},scale:function(t,e,i){return i&&t!==i?(i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i):(t[0]*=e,t[1]*=e,t[2]*=e,t)},normalize:function(t,e){e||(e=t);var i=t[0],r=t[1],n=t[2],o=Math.sqrt(i*i+r*r+n*n);return o?1===o?(e[0]=i,e[1]=r,e[2]=n,e):(o=1/o,e[0]=i*o,e[1]=r*o,e[2]=n*o,e):(e[0]=0,e[1]=0,e[2]=0,e)},cross:function(t,e,i){i||(i=t);var r=t[0],n=t[1],t=t[2],o=e[0],s=e[1],e=e[2];return i[0]=n*e-t*s,i[1]=t*o-r*e,i[2]=r*s-n*o,i},length:function(t){var e=t[0],i=t[1],t=t[2];return Math.sqrt(e*e+i*i+t*t)},squaredLength:function(t){var e=t[0],i=t[1],t=t[2];return e*e+i*i+t*t},dot:function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},direction:function(t,e,i){i||(i=t);var r=t[0]-e[0],n=t[1]-e[1],t=t[2]-e[2],e=Math.sqrt(r*r+n*n+t*t);return e?(e=1/e,i[0]=r*e,i[1]=n*e,i[2]=t*e,i):(i[0]=0,i[1]=0,i[2]=0,i)},lerp:function(t,e,i,r){return r||(r=t),r[0]=t[0]+i*(e[0]-t[0]),r[1]=t[1]+i*(e[1]-t[1]),r[2]=t[2]+i*(e[2]-t[2]),r},dist:function(t,e){var i=e[0]-t[0],r=e[1]-t[1],n=e[2]-t[2];return Math.sqrt(i*i+r*r+n*n)}},s=null,a=new n(4);o.unproject=function(t,e,i,r,n){n||(n=t),s||(s=f.create());var o=s;return a[0]=2*(t[0]-r[0])/r[2]-1,a[1]=2*(t[1]-r[1])/r[3]-1,a[2]=2*t[2]-1,a[3]=1,f.multiply(i,e,o),f.inverse(o)?(f.multiplyVec4(o,a),0===a[3]?null:(n[0]=a[0]/a[3],n[1]=a[1]/a[3],n[2]=a[2]/a[3],n)):null};var c=o.createFrom(1,0,0),u=o.createFrom(0,1,0),h=o.createFrom(0,0,1),l=o.create();o.rotationTo=function(t,e,i){i||(i=d.create());var r=o.dot(t,e);if(r>=1)d.set(m,i);else if(-.999999>r)o.cross(c,t,l),1e-6>o.length(l)&&o.cross(u,t,l),1e-6>o.length(l)&&o.cross(h,t,l),o.normalize(l),d.fromAngleAxis(Math.PI,l,i);else{var r=Math.sqrt(2*(1+r)),n=1/r;o.cross(t,e,l),i[0]=l[0]*n,i[1]=l[1]*n,i[2]=l[2]*n,i[3]=.5*r,d.normalize(i)}return 1<i[3]?i[3]=1:-1>i[3]&&(i[3]=-1),i},o.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+"]"};var p={create:function(t){var e=new n(9);return t?(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8]):e[0]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=0,e},createFrom:function(t,e,i,r,o,s,a,c,u){var h=new n(9);return h[0]=t,h[1]=e,h[2]=i,h[3]=r,h[4]=o,h[5]=s,h[6]=a,h[7]=c,h[8]=u,h},determinant:function(t){var e=t[3],i=t[4],r=t[5],n=t[6],o=t[7],s=t[8];return t[0]*(s*i-r*o)+t[1]*(-s*e+r*n)+t[2]*(o*e-i*n)},inverse:function(t,e){var i=t[0],r=t[1],n=t[2],o=t[3],s=t[4],a=t[5],c=t[6],u=t[7],h=t[8],l=h*s-a*u,f=-h*o+a*c,d=u*o-s*c,m=i*l+r*f+n*d;return m?(m=1/m,e||(e=p.create()),e[0]=l*m,e[1]=(-h*r+n*u)*m,e[2]=(a*r-n*s)*m,e[3]=f*m,e[4]=(h*i-n*c)*m,e[5]=(-a*i+n*o)*m,e[6]=d*m,e[7]=(-u*i+r*c)*m,e[8]=(s*i-r*o)*m,e):null},multiply:function(t,e,i){i||(i=t);var r=t[0],n=t[1],o=t[2],s=t[3],a=t[4],c=t[5],u=t[6],h=t[7],t=t[8],l=e[0],p=e[1],f=e[2],d=e[3],m=e[4],x=e[5],y=e[6],v=e[7],e=e[8];return i[0]=l*r+p*s+f*u,i[1]=l*n+p*a+f*h,i[2]=l*o+p*c+f*t,i[3]=d*r+m*s+x*u,i[4]=d*n+m*a+x*h,i[5]=d*o+m*c+x*t,i[6]=y*r+v*s+e*u,i[7]=y*n+v*a+e*h,i[8]=y*o+v*c+e*t,i},multiplyVec2:function(t,e,i){i||(i=e);var r=e[0],e=e[1];return i[0]=r*t[0]+e*t[3]+t[6],i[1]=r*t[1]+e*t[4]+t[7],i},multiplyVec3:function(t,e,i){i||(i=e);var r=e[0],n=e[1],e=e[2];return i[0]=r*t[0]+n*t[3]+e*t[6],i[1]=r*t[1]+n*t[4]+e*t[7],i[2]=r*t[2]+n*t[5]+e*t[8],i},set:function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},equal:function(t,e){return t===e||1e-6>Math.abs(t[0]-e[0])&&1e-6>Math.abs(t[1]-e[1])&&1e-6>Math.abs(t[2]-e[2])&&1e-6>Math.abs(t[3]-e[3])&&1e-6>Math.abs(t[4]-e[4])&&1e-6>Math.abs(t[5]-e[5])&&1e-6>Math.abs(t[6]-e[6])&&1e-6>Math.abs(t[7]-e[7])&&1e-6>Math.abs(t[8]-e[8])},identity:function(t){return t||(t=p.create()),t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},transpose:function(t,e){if(!e||t===e){var i=t[1],r=t[2],n=t[5];return t[1]=t[3],t[2]=t[6],t[3]=i,t[5]=t[7],t[6]=r,t[7]=n,t}return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],e},toMat4:function(t,e){return e||(e=f.create()),e[15]=1,e[14]=0,e[13]=0,e[12]=0,e[11]=0,e[10]=t[8],e[9]=t[7],e[8]=t[6],e[7]=0,e[6]=t[5],e[5]=t[4],e[4]=t[3],e[3]=0,e[2]=t[2],e[1]=t[1],e[0]=t[0],e},str:function(t){return"["+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+"]"}},f={create:function(t){var e=new n(16);return t&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e},createFrom:function(t,e,i,r,o,s,a,c,u,h,l,p,f,d,m,x){var y=new n(16);return y[0]=t,y[1]=e,y[2]=i,y[3]=r,y[4]=o,y[5]=s,y[6]=a,y[7]=c,y[8]=u,y[9]=h,y[10]=l,y[11]=p,y[12]=f,y[13]=d,y[14]=m,y[15]=x,y},set:function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},equal:function(t,e){return t===e||1e-6>Math.abs(t[0]-e[0])&&1e-6>Math.abs(t[1]-e[1])&&1e-6>Math.abs(t[2]-e[2])&&1e-6>Math.abs(t[3]-e[3])&&1e-6>Math.abs(t[4]-e[4])&&1e-6>Math.abs(t[5]-e[5])&&1e-6>Math.abs(t[6]-e[6])&&1e-6>Math.abs(t[7]-e[7])&&1e-6>Math.abs(t[8]-e[8])&&1e-6>Math.abs(t[9]-e[9])&&1e-6>Math.abs(t[10]-e[10])&&1e-6>Math.abs(t[11]-e[11])&&1e-6>Math.abs(t[12]-e[12])&&1e-6>Math.abs(t[13]-e[13])&&1e-6>Math.abs(t[14]-e[14])&&1e-6>Math.abs(t[15]-e[15])},identity:function(t){return t||(t=f.create()),t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},transpose:function(t,e){if(!e||t===e){var i=t[1],r=t[2],n=t[3],o=t[6],s=t[7],a=t[11];return t[1]=t[4],t[2]=t[8],t[3]=t[12],t[4]=i,t[6]=t[9],t[7]=t[13],t[8]=r,t[9]=o,t[11]=t[14],t[12]=n,t[13]=s,t[14]=a,t}return e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15],e},determinant:function(t){var e=t[0],i=t[1],r=t[2],n=t[3],o=t[4],s=t[5],a=t[6],c=t[7],u=t[8],h=t[9],l=t[10],p=t[11],f=t[12],d=t[13],m=t[14],t=t[15];return f*h*a*n-u*d*a*n-f*s*l*n+o*d*l*n+u*s*m*n-o*h*m*n-f*h*r*c+u*d*r*c+f*i*l*c-e*d*l*c-u*i*m*c+e*h*m*c+f*s*r*p-o*d*r*p-f*i*a*p+e*d*a*p+o*i*m*p-e*s*m*p-u*s*r*t+o*h*r*t+u*i*a*t-e*h*a*t-o*i*l*t+e*s*l*t},inverse:function(t,e){e||(e=t);var i=t[0],r=t[1],n=t[2],o=t[3],s=t[4],a=t[5],c=t[6],u=t[7],h=t[8],l=t[9],p=t[10],f=t[11],d=t[12],m=t[13],x=t[14],y=t[15],v=i*a-r*s,b=i*c-n*s,w=i*u-o*s,g=r*c-n*a,M=r*u-o*a,T=n*u-o*c,B=h*m-l*d,S=h*x-p*d,A=h*y-f*d,R=l*x-p*m,C=l*y-f*m,L=p*y-f*x,F=v*L-b*C+w*R+g*A-M*S+T*B;return F?(F=1/F,e[0]=(a*L-c*C+u*R)*F,e[1]=(-r*L+n*C-o*R)*F,e[2]=(m*T-x*M+y*g)*F,e[3]=(-l*T+p*M-f*g)*F,e[4]=(-s*L+c*A-u*S)*F,e[5]=(i*L-n*A+o*S)*F,e[6]=(-d*T+x*w-y*b)*F,e[7]=(h*T-p*w+f*b)*F,e[8]=(s*C-a*A+u*B)*F,e[9]=(-i*C+r*A-o*B)*F,e[10]=(d*M-m*w+y*v)*F,e[11]=(-h*M+l*w-f*v)*F,e[12]=(-s*R+a*S-c*B)*F,e[13]=(i*R-r*S+n*B)*F,e[14]=(-d*g+m*b-x*v)*F,e[15]=(h*g-l*b+p*v)*F,e):null},toRotationMat:function(t,e){return e||(e=f.create()),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},toMat3:function(t,e){return e||(e=p.create()),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},toInverseMat3:function(t,e){var i=t[0],r=t[1],n=t[2],o=t[4],s=t[5],a=t[6],c=t[8],u=t[9],h=t[10],l=h*s-a*u,f=-h*o+a*c,d=u*o-s*c,m=i*l+r*f+n*d;return m?(m=1/m,e||(e=p.create()),e[0]=l*m,e[1]=(-h*r+n*u)*m,e[2]=(a*r-n*s)*m,e[3]=f*m,e[4]=(h*i-n*c)*m,e[5]=(-a*i+n*o)*m,e[6]=d*m,e[7]=(-u*i+r*c)*m,e[8]=(s*i-r*o)*m,e):null},multiply:function(t,e,i){i||(i=t);var r=t[0],n=t[1],o=t[2],s=t[3],a=t[4],c=t[5],u=t[6],h=t[7],l=t[8],p=t[9],f=t[10],d=t[11],m=t[12],x=t[13],y=t[14],t=t[15],v=e[0],b=e[1],w=e[2],g=e[3];return i[0]=v*r+b*a+w*l+g*m,i[1]=v*n+b*c+w*p+g*x,i[2]=v*o+b*u+w*f+g*y,i[3]=v*s+b*h+w*d+g*t,v=e[4],b=e[5],w=e[6],g=e[7],i[4]=v*r+b*a+w*l+g*m,i[5]=v*n+b*c+w*p+g*x,i[6]=v*o+b*u+w*f+g*y,i[7]=v*s+b*h+w*d+g*t,v=e[8],b=e[9],w=e[10],g=e[11],i[8]=v*r+b*a+w*l+g*m,i[9]=v*n+b*c+w*p+g*x,i[10]=v*o+b*u+w*f+g*y,i[11]=v*s+b*h+w*d+g*t,v=e[12],b=e[13],w=e[14],g=e[15],i[12]=v*r+b*a+w*l+g*m,i[13]=v*n+b*c+w*p+g*x,i[14]=v*o+b*u+w*f+g*y,i[15]=v*s+b*h+w*d+g*t,i},multiplyVec3:function(t,e,i){i||(i=e);var r=e[0],n=e[1],e=e[2];return i[0]=t[0]*r+t[4]*n+t[8]*e+t[12],i[1]=t[1]*r+t[5]*n+t[9]*e+t[13],i[2]=t[2]*r+t[6]*n+t[10]*e+t[14],i},multiplyVec4:function(t,e,i){i||(i=e);var r=e[0],n=e[1],o=e[2],e=e[3];return i[0]=t[0]*r+t[4]*n+t[8]*o+t[12]*e,i[1]=t[1]*r+t[5]*n+t[9]*o+t[13]*e,i[2]=t[2]*r+t[6]*n+t[10]*o+t[14]*e,i[3]=t[3]*r+t[7]*n+t[11]*o+t[15]*e,i},translate:function(t,e,i){var r,n,o,s,a,c,u,h,l,p,f,d,m=e[0],x=e[1],e=e[2];return i&&t!==i?(r=t[0],n=t[1],o=t[2],s=t[3],a=t[4],c=t[5],u=t[6],h=t[7],l=t[8],p=t[9],f=t[10],d=t[11],i[0]=r,i[1]=n,i[2]=o,i[3]=s,i[4]=a,i[5]=c,i[6]=u,i[7]=h,i[8]=l,i[9]=p,i[10]=f,i[11]=d,i[12]=r*m+a*x+l*e+t[12],i[13]=n*m+c*x+p*e+t[13],i[14]=o*m+u*x+f*e+t[14],i[15]=s*m+h*x+d*e+t[15],i):(t[12]=t[0]*m+t[4]*x+t[8]*e+t[12],t[13]=t[1]*m+t[5]*x+t[9]*e+t[13],t[14]=t[2]*m+t[6]*x+t[10]*e+t[14],t[15]=t[3]*m+t[7]*x+t[11]*e+t[15],t)},scale:function(t,e,i){var r=e[0],n=e[1],e=e[2];return i&&t!==i?(i[0]=t[0]*r,i[1]=t[1]*r,i[2]=t[2]*r,i[3]=t[3]*r,i[4]=t[4]*n,i[5]=t[5]*n,i[6]=t[6]*n,i[7]=t[7]*n,i[8]=t[8]*e,i[9]=t[9]*e,i[10]=t[10]*e,i[11]=t[11]*e,i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15],i):(t[0]*=r,t[1]*=r,t[2]*=r,t[3]*=r,t[4]*=n,t[5]*=n,t[6]*=n,t[7]*=n,t[8]*=e,t[9]*=e,t[10]*=e,t[11]*=e,t)},rotate:function(t,e,i,r){var n,o,s,a,c,u,h,l,p,f,d,m,x,y,v,b,w,g,M,T,B=i[0],S=i[1],i=i[2],A=Math.sqrt(B*B+S*S+i*i);return A?(1!==A&&(A=1/A,B*=A,S*=A,i*=A),n=Math.sin(e),o=Math.cos(e),s=1-o,e=t[0],A=t[1],a=t[2],c=t[3],u=t[4],h=t[5],l=t[6],p=t[7],f=t[8],d=t[9],m=t[10],x=t[11],y=B*B*s+o,v=S*B*s+i*n,b=i*B*s-S*n,w=B*S*s-i*n,g=S*S*s+o,M=i*S*s+B*n,T=B*i*s+S*n,B=S*i*s-B*n,S=i*i*s+o,r?t!==r&&(r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]):r=t,r[0]=e*y+u*v+f*b,r[1]=A*y+h*v+d*b,r[2]=a*y+l*v+m*b,r[3]=c*y+p*v+x*b,r[4]=e*w+u*g+f*M,r[5]=A*w+h*g+d*M,r[6]=a*w+l*g+m*M,r[7]=c*w+p*g+x*M,r[8]=e*T+u*B+f*S,r[9]=A*T+h*B+d*S,r[10]=a*T+l*B+m*S,r[11]=c*T+p*B+x*S,r):null},rotateX:function(t,e,i){var r=Math.sin(e),e=Math.cos(e),n=t[4],o=t[5],s=t[6],a=t[7],c=t[8],u=t[9],h=t[10],l=t[11];return i?t!==i&&(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]):i=t,i[4]=n*e+c*r,i[5]=o*e+u*r,i[6]=s*e+h*r,i[7]=a*e+l*r,i[8]=n*-r+c*e,i[9]=o*-r+u*e,i[10]=s*-r+h*e,i[11]=a*-r+l*e,i},rotateY:function(t,e,i){var r=Math.sin(e),e=Math.cos(e),n=t[0],o=t[1],s=t[2],a=t[3],c=t[8],u=t[9],h=t[10],l=t[11];return i?t!==i&&(i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]):i=t,i[0]=n*e+c*-r,i[1]=o*e+u*-r,i[2]=s*e+h*-r,i[3]=a*e+l*-r,i[8]=n*r+c*e,i[9]=o*r+u*e,i[10]=s*r+h*e,i[11]=a*r+l*e,i
},rotateZ:function(t,e,i){var r=Math.sin(e),e=Math.cos(e),n=t[0],o=t[1],s=t[2],a=t[3],c=t[4],u=t[5],h=t[6],l=t[7];return i?t!==i&&(i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]):i=t,i[0]=n*e+c*r,i[1]=o*e+u*r,i[2]=s*e+h*r,i[3]=a*e+l*r,i[4]=n*-r+c*e,i[5]=o*-r+u*e,i[6]=s*-r+h*e,i[7]=a*-r+l*e,i},frustum:function(t,e,i,r,n,o,s){s||(s=f.create());var a=e-t,c=r-i,u=o-n;return s[0]=2*n/a,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=2*n/c,s[6]=0,s[7]=0,s[8]=(e+t)/a,s[9]=(r+i)/c,s[10]=-(o+n)/u,s[11]=-1,s[12]=0,s[13]=0,s[14]=-(2*o*n)/u,s[15]=0,s},perspective:function(t,e,i,r,n){return t=i*Math.tan(t*Math.PI/360),e*=t,f.frustum(-e,e,-t,t,i,r,n)},ortho:function(t,e,i,r,n,o,s){s||(s=f.create());var a=e-t,c=r-i,u=o-n;return s[0]=2/a,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=2/c,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=-2/u,s[11]=0,s[12]=-(t+e)/a,s[13]=-(r+i)/c,s[14]=-(o+n)/u,s[15]=1,s},lookAt:function(t,e,i,r){r||(r=f.create());var n,o,s,a,c,u,h,l,p=t[0],d=t[1],t=t[2];return s=i[0],a=i[1],o=i[2],h=e[0],i=e[1],n=e[2],p===h&&d===i&&t===n?f.identity(r):(e=p-h,i=d-i,h=t-n,l=1/Math.sqrt(e*e+i*i+h*h),e*=l,i*=l,h*=l,n=a*h-o*i,o=o*e-s*h,s=s*i-a*e,(l=Math.sqrt(n*n+o*o+s*s))?(l=1/l,n*=l,o*=l,s*=l):s=o=n=0,a=i*s-h*o,c=h*n-e*s,u=e*o-i*n,(l=Math.sqrt(a*a+c*c+u*u))?(l=1/l,a*=l,c*=l,u*=l):u=c=a=0,r[0]=n,r[1]=a,r[2]=e,r[3]=0,r[4]=o,r[5]=c,r[6]=i,r[7]=0,r[8]=s,r[9]=u,r[10]=h,r[11]=0,r[12]=-(n*p+o*d+s*t),r[13]=-(a*p+c*d+u*t),r[14]=-(e*p+i*d+h*t),r[15]=1,r)},fromRotationTranslation:function(t,e,i){i||(i=f.create());var r=t[0],n=t[1],o=t[2],s=t[3],a=r+r,c=n+n,u=o+o,t=r*a,h=r*c,r=r*u,l=n*c,n=n*u,o=o*u,a=s*a,c=s*c,s=s*u;return i[0]=1-(l+o),i[1]=h+s,i[2]=r-c,i[3]=0,i[4]=h-s,i[5]=1-(t+o),i[6]=n+a,i[7]=0,i[8]=r+c,i[9]=n-a,i[10]=1-(t+l),i[11]=0,i[12]=e[0],i[13]=e[1],i[14]=e[2],i[15]=1,i},str:function(t){return"["+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+"]"}},d={create:function(t){var e=new n(4);return t?(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]):e[0]=e[1]=e[2]=e[3]=0,e},createFrom:function(t,e,i,r){var o=new n(4);return o[0]=t,o[1]=e,o[2]=i,o[3]=r,o},set:function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},equal:function(t,e){return t===e||1e-6>Math.abs(t[0]-e[0])&&1e-6>Math.abs(t[1]-e[1])&&1e-6>Math.abs(t[2]-e[2])&&1e-6>Math.abs(t[3]-e[3])},identity:function(t){return t||(t=d.create()),t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}},m=d.identity();d.calculateW=function(t,e){var i=t[0],r=t[1],n=t[2];return e&&t!==e?(e[0]=i,e[1]=r,e[2]=n,e[3]=-Math.sqrt(Math.abs(1-i*i-r*r-n*n)),e):(t[3]=-Math.sqrt(Math.abs(1-i*i-r*r-n*n)),t)},d.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]},d.inverse=function(t,e){var i=t[0],r=t[1],n=t[2],o=t[3],i=(i=i*i+r*r+n*n+o*o)?1/i:0;return e&&t!==e?(e[0]=-t[0]*i,e[1]=-t[1]*i,e[2]=-t[2]*i,e[3]=t[3]*i,e):(t[0]*=-i,t[1]*=-i,t[2]*=-i,t[3]*=i,t)},d.conjugate=function(t,e){return e&&t!==e?(e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e):(t[0]*=-1,t[1]*=-1,t[2]*=-1,t)},d.length=function(t){var e=t[0],i=t[1],r=t[2],t=t[3];return Math.sqrt(e*e+i*i+r*r+t*t)},d.normalize=function(t,e){e||(e=t);var i=t[0],r=t[1],n=t[2],o=t[3],s=Math.sqrt(i*i+r*r+n*n+o*o);return 0===s?(e[0]=0,e[1]=0,e[2]=0,e[3]=0,e):(s=1/s,e[0]=i*s,e[1]=r*s,e[2]=n*s,e[3]=o*s,e)},d.add=function(t,e,i){return i&&t!==i?(i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i[3]=t[3]+e[3],i):(t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t[3]+=e[3],t)},d.multiply=function(t,e,i){i||(i=t);var r=t[0],n=t[1],o=t[2],t=t[3],s=e[0],a=e[1],c=e[2],e=e[3];return i[0]=r*e+t*s+n*c-o*a,i[1]=n*e+t*a+o*s-r*c,i[2]=o*e+t*c+r*a-n*s,i[3]=t*e-r*s-n*a-o*c,i},d.multiplyVec3=function(t,e,i){i||(i=e);var r=e[0],n=e[1],o=e[2],e=t[0],s=t[1],a=t[2],t=t[3],c=t*r+s*o-a*n,u=t*n+a*r-e*o,h=t*o+e*n-s*r,r=-e*r-s*n-a*o;return i[0]=c*t+r*-e+u*-a-h*-s,i[1]=u*t+r*-s+h*-e-c*-a,i[2]=h*t+r*-a+c*-s-u*-e,i},d.scale=function(t,e,i){return i&&t!==i?(i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i[3]=t[3]*e,i):(t[0]*=e,t[1]*=e,t[2]*=e,t[3]*=e,t)},d.toMat3=function(t,e){e||(e=p.create());var i=t[0],r=t[1],n=t[2],o=t[3],s=i+i,a=r+r,c=n+n,u=i*s,h=i*a,i=i*c,l=r*a,r=r*c,n=n*c,s=o*s,a=o*a,o=o*c;return e[0]=1-(l+n),e[1]=h+o,e[2]=i-a,e[3]=h-o,e[4]=1-(u+n),e[5]=r+s,e[6]=i+a,e[7]=r-s,e[8]=1-(u+l),e},d.toMat4=function(t,e){e||(e=f.create());var i=t[0],r=t[1],n=t[2],o=t[3],s=i+i,a=r+r,c=n+n,u=i*s,h=i*a,i=i*c,l=r*a,r=r*c,n=n*c,s=o*s,a=o*a,o=o*c;return e[0]=1-(l+n),e[1]=h+o,e[2]=i-a,e[3]=0,e[4]=h-o,e[5]=1-(u+n),e[6]=r+s,e[7]=0,e[8]=i+a,e[9]=r-s,e[10]=1-(u+l),e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},d.slerp=function(t,e,i,r){r||(r=t);var n,o,s=t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3];return 1<=Math.abs(s)?(r!==t&&(r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3]),r):(n=Math.acos(s),o=Math.sqrt(1-s*s),.001>Math.abs(o)?(r[0]=.5*t[0]+.5*e[0],r[1]=.5*t[1]+.5*e[1],r[2]=.5*t[2]+.5*e[2],r[3]=.5*t[3]+.5*e[3],r):(s=Math.sin((1-i)*n)/o,i=Math.sin(i*n)/o,r[0]=t[0]*s+e[0]*i,r[1]=t[1]*s+e[1]*i,r[2]=t[2]*s+e[2]*i,r[3]=t[3]*s+e[3]*i,r))},d.fromRotationMatrix=function(t,e){e||(e=d.create());var i,r=t[0]+t[4]+t[8];if(r>0)i=Math.sqrt(r+1),e[3]=.5*i,i=.5/i,e[0]=(t[7]-t[5])*i,e[1]=(t[2]-t[6])*i,e[2]=(t[3]-t[1])*i;else{i=d.fromRotationMatrix.s_iNext=d.fromRotationMatrix.s_iNext||[1,2,0],r=0,t[4]>t[0]&&(r=1),t[8]>t[3*r+r]&&(r=2);var n=i[r],o=i[n];i=Math.sqrt(t[3*r+r]-t[3*n+n]-t[3*o+o]+1),e[r]=.5*i,i=.5/i,e[3]=(t[3*o+n]-t[3*n+o])*i,e[n]=(t[3*n+r]+t[3*r+n])*i,e[o]=(t[3*o+r]+t[3*r+o])*i}return e},p.toQuat4=d.fromRotationMatrix,function(){var t=p.create();d.fromAxes=function(e,i,r,n){return t[0]=i[0],t[3]=i[1],t[6]=i[2],t[1]=r[0],t[4]=r[1],t[7]=r[2],t[2]=e[0],t[5]=e[1],t[8]=e[2],d.fromRotationMatrix(t,n)}}(),d.identity=function(t){return t||(t=d.create()),t[0]=0,t[1]=0,t[2]=0,t[3]=1,t},d.fromAngleAxis=function(t,e,i){i||(i=d.create());var t=.5*t,r=Math.sin(t);return i[3]=Math.cos(t),i[0]=r*e[0],i[1]=r*e[1],i[2]=r*e[2],i},d.toAngleAxis=function(t,e){e||(e=t);var i=t[0]*t[0]+t[1]*t[1]+t[2]*t[2];return i>0?(e[3]=2*Math.acos(t[3]),i=r.invsqrt(i),e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i):(e[3]=0,e[0]=1,e[1]=0,e[2]=0),e},d.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+"]"};var x={create:function(t){var e=new n(2);return t?(e[0]=t[0],e[1]=t[1]):(e[0]=0,e[1]=0),e},createFrom:function(t,e){var i=new n(2);return i[0]=t,i[1]=e,i},add:function(t,e,i){return i||(i=e),i[0]=t[0]+e[0],i[1]=t[1]+e[1],i},subtract:function(t,e,i){return i||(i=e),i[0]=t[0]-e[0],i[1]=t[1]-e[1],i},multiply:function(t,e,i){return i||(i=e),i[0]=t[0]*e[0],i[1]=t[1]*e[1],i},divide:function(t,e,i){return i||(i=e),i[0]=t[0]/e[0],i[1]=t[1]/e[1],i},scale:function(t,e,i){return i||(i=t),i[0]=t[0]*e,i[1]=t[1]*e,i},dist:function(t,e){var i=e[0]-t[0],r=e[1]-t[1];return Math.sqrt(i*i+r*r)},set:function(t,e){return e[0]=t[0],e[1]=t[1],e},equal:function(t,e){return t===e||1e-6>Math.abs(t[0]-e[0])&&1e-6>Math.abs(t[1]-e[1])},negate:function(t,e){return e||(e=t),e[0]=-t[0],e[1]=-t[1],e},normalize:function(t,e){e||(e=t);var i=t[0]*t[0]+t[1]*t[1];return i>0?(i=Math.sqrt(i),e[0]=t[0]/i,e[1]=t[1]/i):e[0]=e[1]=0,e},cross:function(t,e,i){return t=t[0]*e[1]-t[1]*e[0],i?(i[0]=i[1]=0,i[2]=t,i):t},length:function(t){var e=t[0],t=t[1];return Math.sqrt(e*e+t*t)},squaredLength:function(t){var e=t[0],t=t[1];return e*e+t*t},dot:function(t,e){return t[0]*e[0]+t[1]*e[1]},direction:function(t,e,i){i||(i=t);var r=t[0]-e[0],t=t[1]-e[1],e=r*r+t*t;return e?(e=1/Math.sqrt(e),i[0]=r*e,i[1]=t*e,i):(i[0]=0,i[1]=0,i[2]=0,i)},lerp:function(t,e,i,r){return r||(r=t),r[0]=t[0]+i*(e[0]-t[0]),r[1]=t[1]+i*(e[1]-t[1]),r},str:function(t){return"["+t[0]+", "+t[1]+"]"}},y={create:function(t){var e=new n(4);return t?(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]):e[0]=e[1]=e[2]=e[3]=0,e},createFrom:function(t,e,i,r){var o=new n(4);return o[0]=t,o[1]=e,o[2]=i,o[3]=r,o},set:function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},equal:function(t,e){return t===e||1e-6>Math.abs(t[0]-e[0])&&1e-6>Math.abs(t[1]-e[1])&&1e-6>Math.abs(t[2]-e[2])&&1e-6>Math.abs(t[3]-e[3])},identity:function(t){return t||(t=y.create()),t[0]=1,t[1]=0,t[2]=0,t[3]=1,t},transpose:function(t,e){if(!e||t===e){var i=t[1];return t[1]=t[2],t[2]=i,t}return e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3],e},determinant:function(t){return t[0]*t[3]-t[2]*t[1]},inverse:function(t,e){e||(e=t);var i=t[0],r=t[1],n=t[2],o=t[3],s=i*o-n*r;return s?(s=1/s,e[0]=o*s,e[1]=-r*s,e[2]=-n*s,e[3]=i*s,e):null},multiply:function(t,e,i){i||(i=t);var r=t[0],n=t[1],o=t[2],t=t[3];return i[0]=r*e[0]+n*e[2],i[1]=r*e[1]+n*e[3],i[2]=o*e[0]+t*e[2],i[3]=o*e[1]+t*e[3],i},rotate:function(t,e,i){i||(i=t);var r=t[0],n=t[1],o=t[2],t=t[3],s=Math.sin(e),e=Math.cos(e);return i[0]=r*e+n*s,i[1]=r*-s+n*e,i[2]=o*e+t*s,i[3]=o*-s+t*e,i},multiplyVec2:function(t,e,i){i||(i=e);var r=e[0],e=e[1];return i[0]=r*t[0]+e*t[1],i[1]=r*t[2]+e*t[3],i},scale:function(t,e,i){i||(i=t);var r=t[1],n=t[2],o=t[3],s=e[0],e=e[1];return i[0]=t[0]*s,i[1]=r*e,i[2]=n*s,i[3]=o*e,i},str:function(t){return"["+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+"]"}},v={create:function(t){var e=new n(4);return t?(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]):(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e},createFrom:function(t,e,i,r){var o=new n(4);return o[0]=t,o[1]=e,o[2]=i,o[3]=r,o},add:function(t,e,i){return i||(i=e),i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i[3]=t[3]+e[3],i},subtract:function(t,e,i){return i||(i=e),i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i[3]=t[3]-e[3],i},multiply:function(t,e,i){return i||(i=e),i[0]=t[0]*e[0],i[1]=t[1]*e[1],i[2]=t[2]*e[2],i[3]=t[3]*e[3],i},divide:function(t,e,i){return i||(i=e),i[0]=t[0]/e[0],i[1]=t[1]/e[1],i[2]=t[2]/e[2],i[3]=t[3]/e[3],i},scale:function(t,e,i){return i||(i=t),i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i[3]=t[3]*e,i},set:function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},equal:function(t,e){return t===e||1e-6>Math.abs(t[0]-e[0])&&1e-6>Math.abs(t[1]-e[1])&&1e-6>Math.abs(t[2]-e[2])&&1e-6>Math.abs(t[3]-e[3])},negate:function(t,e){return e||(e=t),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e},length:function(t){var e=t[0],i=t[1],r=t[2],t=t[3];return Math.sqrt(e*e+i*i+r*r+t*t)},squaredLength:function(t){var e=t[0],i=t[1],r=t[2],t=t[3];return e*e+i*i+r*r+t*t},lerp:function(t,e,i,r){return r||(r=t),r[0]=t[0]+i*(e[0]-t[0]),r[1]=t[1]+i*(e[1]-t[1]),r[2]=t[2]+i*(e[2]-t[2]),r[3]=t[3]+i*(e[3]-t[3]),r},str:function(t){return"["+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+"]"}};return t&&(t.glMatrixArrayType=n,t.MatrixArray=n,t.setMatrixArrayType=e,t.determineMatrixArrayType=i,t.glMath=r,t.vec2=x,t.vec3=o,t.vec4=v,t.mat2=y,t.mat3=p,t.mat4=f,t.quat4=d),{glMatrixArrayType:n,MatrixArray:n,setMatrixArrayType:e,determineMatrixArrayType:i,glMath:r,vec2:x,vec3:o,vec4:v,mat2:y,mat3:p,mat4:f,quat4:d}}),ListNode.prototype.item=null,ListNode.prototype.link=null,List.prototype.head=null,List.prototype.tail=null,List.prototype.length=0,List.prototype.push=function(t){var e=new ListNode(t);null===this.head?this.head=e:this.tail.link=e,this.tail=e,this.length++},List.prototype.push_front=function(t){var e=new ListNode(t);null===this.head?this.tail=e:e.link=this.head,this.head=e,this.length++},List.prototype.push_back=function(t){this.push(t)},List.prototype.pop=function(){var t=null;return null!=this.head&&(t=this.head.item,this.tail==this.head&&(this.tail=null),this.head=this.head.link,this.length--),t},List.prototype.pop_front=function(){return this.pop()},List.prototype.pop_back=function(){var t=null;return null!=this.head&&null!=this.tail&&(t=this.tail.item,this.remove(t)),t},List.prototype.remove=function(t){if(null!=this.head){if(this.head.item===t)return this.head=this.head.link,this.length--,!0;for(var e=this.head,i=this.head.link;null!==i;){if(i.item===t)return e.link=i.link,this.tail.item===t&&(this.tail=e),this.length--,!0;e=i,i=i.link}}return!1},List.prototype.find=function(t){for(var e=this.head;null!==e;e=e.link)if(e.item==t)return!0;return!1},List.prototype.getAt=function(t){var e=null,i=this.head;if(t>=0&&t<this.length){for(;t>0&&null!=i;)i=i.link,t--;e=i.item}return e},List.prototype.foreach=function(t,e){for(var i=this.head;null!==i;i=i.link)t(i.item,e)},List.prototype.toString=function(){for(var t=0,e=this.head,i="";null!==e;)i+="["+t+": ",i+=e.item+"]",e=e.link,t++;return i},Vector.prototype.x=0,Vector.prototype.y=0,Vector.prototype.z=0,Vector.prototype.w=0,Vector.prototype.r=0,Vector.prototype.g=0,Vector.prototype.b=0,Vector.prototype.a=0,Vector.prototype.length=0,Vector.prototype={get r(){return this.x},set r(t){this.x=t},get g(){return this.y},set g(t){this.y=t},get b(){return this.z},set b(t){this.z=t},get a(){return this.w},set a(t){this.w=t},get length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}},Vector.prototype.add=function(t){var e=new Vector(0,0,0);return e.x=this.x+t.x,e.y=this.y+t.y,e.z=this.z+t.z,e.w=this.w+t.w,e},Vector.prototype.sub=function(t){var e=new Vector(0,0,0);return e.x=this.x-t.x,e.y=this.y-t.y,e.z=this.z-t.z,e.w=this.w-t.w,e},Vector.prototype.mult=function(t){var e=new Vector(0,0,0);return t instanceof Vector?(e.x=this.x*t.x,e.y=this.y*t.y,e.z=this.z*t.z,e.w=this.w*t.w):(e.x=this.x*t,e.y=this.y*t,e.z=this.z*t,e.w=this.w*t),e},Vector.prototype.div=function(t){var e=new Vector(0,0,0);return t instanceof Vector?(e.x=this.x/t.x,e.y=this.y/t.y,e.z=this.z/t.z,e.w=this.w/t.w):(e.x=this.x/t,e.y=this.y/t,e.z=this.z/t,e.w=this.w/t),e},Vector.prototype.neg=function(){var t=new Vector(0,0,0);return t.x=-this.x,t.y=-this.y,t.z=-this.z,t.w=-this.w,t},Vector.prototype.equals=function(t){return this.x!=t.x?!1:this.y!=t.y?!1:this.z!=t.z?!1:this.w!=t.w?!1:!0},Vector.prototype.cross=function(t){var e=new Vector(0,0,0);return e.x=this.y*t.z-this.z*t.y,e.y=this.z*t.x-this.x*t.z,e.z=this.x*t.y-this.y*t.x,e},Vector.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},Vector.prototype.normalize=function(){var t=this.length,e=new Vector(0,0,0);return e.x=this.x/t,e.y=this.y/t,e.z=this.z/t,e.w=this.w/t,e},Vector.prototype.toString=function(){return"["+this.x+","+this.y+","+this.z+","+this.w+"]"},Vector.arrayVector=function(t){var e=new Vector(t[0],t[1],t[2]?t[2]:0);return e.w=t[3]?t[3]:0,e},ResourceMonitor.prototype.instance=null,ResourceMonitor.prototype.loadList=new List,ResourceMonitor.prototype.totalItems=0,ResourceMonitor.prototype.leftToLoad=0,ResourceMonitor.prototype.addToLoad=function(){this.totalItems++,this.leftToLoad++},ResourceMonitor.prototype.getLeftToLoad=function(){for(var t in Fonts.fonts)Fonts.fonts[t].loaded||Fonts.fonts[t].checkIfLoaded();return this.leftToLoad},ResourceMonitor.prototype.percentLoaded=function(){for(var t in Fonts.fonts)Fonts.fonts[t].loaded||Fonts.fonts[t].checkIfLoaded();return this.leftToLoad/this.totalItems};var Resources=new ResourceMonitor;TextureManager.prototype.instance=null,TextureManager.prototype.imgs=new Array,TextureManager.prototype.waitingList=new List,TextureManager.prototype.load=function(t,e,i){return void 0==this.imgs[t]&&(Resources.addToLoad(),this.imgs[t]=new Image,this.imgs[t].loaded=!1,e&&(this.imgs[t].crossOrigin="anonymous"),this.imgs[t].src=t,this.imgs[t].onload=function(){i&&println(this.src+" loaded"),Resources.leftToLoad--,Textures.createTexture(this)||Textures.waitingList.push(this),this.loaded=!0},this.imgs[t].onabort=function(){alert("there was an error")}),this.imgs[t]},TextureManager.prototype.create=function(){this.waitingList.foreach(Textures.createTexture)},TextureManager.prototype.createTexture=function(t){if(void 0!=ctx&&ctx.createTexture){var e=t.texture;return void 0==e&&(e=ctx.createTexture()),e.image=t,ctx.bindTexture(ctx.TEXTURE_2D,e),ctx.pixelStorei(ctx.UNPACK_FLIP_Y_WEBGL,!0),ctx.pixelStorei(ctx.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),ctx.texImage2D(ctx.TEXTURE_2D,0,ctx.RGBA,ctx.RGBA,ctx.UNSIGNED_BYTE,e.image),ctx.texParameteri(ctx.TEXTURE_2D,ctx.TEXTURE_WRAP_S,ctx.CLAMP_TO_EDGE),ctx.texParameteri(ctx.TEXTURE_2D,ctx.TEXTURE_WRAP_T,ctx.CLAMP_TO_EDGE),ctx.texParameteri(ctx.TEXTURE_2D,ctx.TEXTURE_MIN_FILTER,ctx.LINEAR),ctx.texParameteri(ctx.TEXTURE_2D,ctx.TEXTURE_MAG_FILTER,ctx.LINEAR),ctx.bindTexture(ctx.TEXTURE_2D,null),t.texture=e,!0}return!1};var Textures=new TextureManager;SoundManager.prototype.instance=null,SoundManager.prototype.snds=new Array,SoundManager.prototype.muted=!1,SoundManager.prototype.load=function(t){if(void 0==this.snds[t])return Resources.addToLoad(),this.snds[t]=new List,Sounds.makeNewAudio(t,!0);for(var e=this.snds[t].head;null!=e;e=e.link){var i=e.item;if(!i.isPlaying||i.currentTime==i.duration)return i.src=t,i}return Sounds.makeNewAudio(t,!1)},SoundManager.prototype.makeNewAudio=function(t,e){var i=new Audio;i.loaded=!1,i.isPlaying=!1,i.muted=Sounds.muted,i.addEventListener("canplaythrough",function(){e&&!this.loaded&&(println(this.src+" loaded"),Resources.leftToLoad--,this.loaded=!0)},!1);var r=i.constructor.prototype;return i.play=function(){this.isPlaying=!0,r.play.call(this)},i.pause=function(){this.isPlaying=!1,r.pause.call(this)},i.ended=function(){this.isPlaying=!1},i.src=t,Sounds.snds[t].push(i),i},SoundManager.prototype.play=function(t){var e=this.load(t);return e.play(),e},SoundManager.prototype.loop=function(t){var e=this.load(t);return e.addEventListener("ended",function(){this.src=this.src,this.play()}),e.play(),e},SoundManager.prototype.toggleMuted=function(){this.muted=!this.muted;for(src in Sounds.snds)Sounds.snds[src].foreach(toggleSounds,{})};var Sounds=new SoundManager;FontManager.prototype.instance=null,FontManager.prototype.fonts=new Array,FontManager.prototype.load=function(t){if(void 0==Fonts.fonts[t]){Resources.addToLoad();var e=document.createElement("p");e.loaded=!1,e.font=t,e.innerHTML="AAAAAAAAAA",e.style.position="absolute",e.style.visibility="hidden",e.style.top=0,e.style.display="inline-block",e.style.font="20px "+t+",cursive",e.checkIfLoaded=function(){document.body.appendChild(this),this.style.font="20px Arial,cursive",println(this.offsetWidth);var t=this.offsetWidth;return this.style.font="20px "+this.font+",cursive",println(this.offsetWidth),this.offsetWidth!=t?(this.loaded=!0,Resources.leftToLoad--,!0):(document.body.removeChild(this),!1)},Fonts.fonts[t]=e}};var Fonts=new FontManager;FileManager.prototype.instance=null,FileManager.prototype.files=new Array,FileManager.prototype.load=function(t,e){if(void 0==this.files[t]){this.files[t]=new Object,Resources.addToLoad();var i=xmlRequest();i.onreadystatechange=function(){4==i.readyState&&(Files.files[t].text=String(i.responseText),Files.files[t].xml=i.responseXML,null!=e&&e(Files.files[t]),Resources.leftToLoad--)};try{i.open("GET",t,!0),i.send(null)}catch(r){}}return this.files[t]};var Files=new FileManager,mvMatrix=mat4.create(),pMatrix=mat4.create(),shaderProgram,vertShader,fragShader,spriteShader,spriteVPB,spriteVTB,spriteVIB,colorBuffer,stateBuffer,sBuffers=new Object;BLEND_ALPHA={a:"SRC_ALPHA",b:"ONE_MINUS_SRC_ALPHA"},BLEND_ADD={a:"SRC_ALPHA",b:"ONE"},BLEND_MULTIPLY={a:"DST_COLOR",b:"ZERO"},sBuffers.buffers=new Array,sBuffers.getBuffer=function(t,e){for(var i=0;i<this.buffers.length;i++)if(!this.buffers[i].locked)return this.buffers[i];var r=t?t:canvas.width,n=e?e:canvas.height,o=createRenderTarget(ctx,r,n);return o.locked=!1,o.lock=function(){this.locked=!0},o.unlock=function(){this.locked=!1},this.buffers.push(o),o};var defaultVertSrc=new Object;defaultVertSrc.code="attribute vec3 aVertexPosition; attribute vec2 aTextureCoord; uniform mat4 uMVMatrix; uniform mat4 uPMatrix; varying vec2 vTextureCoord; void main(void){ gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0); vTextureCoord = aTextureCoord; }",defaultVertSrc.type="vert";var defaultFragSrc=new Object;defaultFragSrc.code="precision mediump float; varying vec2 vTextureCoord; uniform sampler2D uSampler; uniform vec2 frameOffset; uniform vec2 frameDims; uniform vec2 tiles; uniform vec2 scroll; uniform vec3 multColor; uniform float alpha; void main(void){ vec2 pos = mod((vTextureCoord+scroll)*tiles+vec2(0, 1.0-tiles.y),vec2(1.0,1.0)); pos = pos*frameDims; pos.y += (1.0-frameDims.y); pos.y -= frameOffset.y; pos.x += frameOffset.x; vec4 color = texture2D(uSampler, pos); gl_FragColor.rgb = color.rgb*multColor; gl_FragColor.a = color.a*alpha; }",defaultFragSrc.type="frag",PostFXChain.prototype.effects=new List,PostFXChain.prototype.push=function(t){this.effects.push(t)},PostFXChain.prototype.remove=function(t){this.effects.remove(t)},PostFXChain.prototype.apply=function(t,e){for(var i,r=this.effects.head;null!=r;r=r.link)i=r.item,void 0!=i&&null!=i&&i.apply(t,e)},PostFX.prototype.apply=function(){},Sprite.prototype={get x(){return this.pos.x},set x(t){this.pos.x=t},get y(){return this.pos.y},set y(t){this.pos.y=t},get z(){return this.pos.z},set z(t){this.pos.z=t},get worldRotation(){return this.parent?this.parent.worldRotation+this.rotation:this.rotation},set worldRotation(t){this.rotation=this.parent?t-this.parent.worldRotation:t},get blendFunc(){return this.blendFunction},set blendFunc(t){this.blendFunction.a=t.a,this.blendFunction.b=t.b}},Sprite.prototype.width=100,Sprite.prototype.height=100,Sprite.prototype.xoffset=0,Sprite.prototype.yoffset=0,Sprite.prototype.scaleX=1,Sprite.prototype.scaleY=1,Sprite.prototype.rotation=0,Sprite.prototype.frameCount=1,Sprite.prototype.frameWidth=-1,Sprite.prototype.frameHeight=-1,Sprite.prototype.frame=0,Sprite.prototype.frameRate=30,Sprite.prototype.tilesX=1,Sprite.prototype.tilesY=1,Sprite.prototype.scrollX=0,Sprite.prototype.scrollY=0,Sprite.prototype.sliceX=0,Sprite.prototype.sliceY=0,Sprite.prototype.sliceWidth=void 0,Sprite.prototype.sliceHeight=void 0,Sprite.prototype.visible=!0,Sprite.prototype.alpha=1,Sprite.prototype.preAlpha=1,Sprite.prototype.blendMode="source-over",Sprite.prototype.childindex=0,Sprite.prototype.index=0,Sprite.prototype.children=new List,Sprite.prototype.shader=null,Sprite.prototype.animations=new Array,Sprite.prototype.animation=null,Sprite.prototype.init=function(){this.children=new List,this.image=new Image,this.pos=new Vector(0,0,0),this.multColor=new Vector(1,1,1)},Sprite.prototype.addChild=function(t){this.children.push(t),t.parent=this},Sprite.prototype.removeChild=function(t){this.children.remove(t)},Sprite.prototype.transform=function(t){t.save(),this.preAlpha=t.alpha,t.alpha*=this.alpha;var e=this.x,i=this.y,r=0==this.scaleX?1e-7:this.scaleX,n=0==this.scaleY?1e-7:this.scaleY;t.translate(e,i),t.rotate(this.rotation),t.scale(r,n)},Sprite.prototype.draw=function(t){if(void 0!=this.image&&null!=this.image)try{this.frameCount<=1?t.drawSprite(this):t.drawSprite(this,this.frame)}catch(e){}this.drawChildren(t)},Sprite.prototype.drawChildren=function(t){for(var e=new Array,i=this.children.head;null!==i;i=i.link){var r=i.item;r.visible&&e.push(r)}e.sort(sortByZ);for(var n=0;n<e.length;n++)e[n].transform(t),e[n].draw(t),e[n].unTransform(t)},Sprite.prototype.unTransform=function(t){t.restore(),t.alpha=this.preAlpha},Sprite.prototype.update=function(t){this.updateChildren(t)},Sprite.prototype.updateChildren=function(t){this.children.foreach(this.updateChild,{delta:t})},Sprite.prototype.updateChild=function(t,e){void 0!=t.animate&&null!=t.animate&&t.animate(e.delta),void 0!=t.update&&null!=t.update&&t.update(e.delta)},Sprite.prototype.addAnimation=function(t,e,i){this.animations[t]={first:e,last:Math.max(0,e+i-1)}},Sprite.prototype.removeAnimation=function(t){this.animations[t]=null},Sprite.prototype.addAnimations=function(t,e){for(var i=0,r=0;r<t.length;r++)this.animations[t[r]]={first:i,last:i+e[r]-1},i+=e[r]},Sprite.prototype.animate=function(t){if(this.frame=this.frame+this.frameRate/FPS*t,0!=this.frame&&(this.frame=this.frame/Math.abs(this.frame)*(Math.abs(this.frame)%this.frameCount)),this.frame<0&&(this.frame+=this.frameCount),exists(this.animation)){var e=this.animations[this.animation];if(exists(e)){var i=e.first,r=e.last;this.frame>r?this.frame=i:this.frame<i&&(this.frame=r)}}},Sprite.prototype.getscaleX=function(){return void 0!=this.parent?this.parent.getscaleX()*this.scaleX:this.scaleX},Sprite.prototype.getscaleY=function(){return void 0!=this.parent?this.parent.getscaleY()*this.scaleY:this.scaleY},Sprite.prototype.getWorldMatrix=function(){var t=mat4.create();return mat4.identity(t),void 0!=this.parent&&(t=this.parent.getWorldMatrix()),mat4.translate(t,[this.x,this.y,this.z]),mat4.rotateZ(t,this.rotation),mat4.scale(t,[this.scaleX,this.scaleY,1]),t},Sprite.prototype.getWorldPos=function(){return mat4.multiplyVec3(this.getWorldMatrix(),[0,0,0])},Sprite.prototype.localToWorld=function(t,e){return mat4.multiplyVec3(this.getWorldMatrix(),[t,e,0])},Sprite.prototype.worldToLocal=function(t,e){var i=vec3.subtract([t,e,0],this.getWorldPos()),r=(0==this.scaleX?1e-7:this.scaleX,0==this.scaleY?1e-7:this.scaleY,mat4.scale(mat4.rotateZ(mat4.identity(mat4.create()),-this.worldRotation),[this.getscaleX(),this.getscaleY(),1]));return mat4.multiplyVec3(r,i)},Sprite.prototype.remove=function(){for(var t=this.children.head;null!==t;t=t.link)t.item.remove();void 0!=this.parent&&this.parent.removeChild(this)},BBox.prototype={get x(){return this.pos.x},set x(t){this.pos.x=t},get y(){return this.pos.y},set y(t){this.pos.y=t},get z(){return this.pos.z},set z(t){this.pos.z=t},get width(){return this.dims.x},set width(t){this.dims.x=t},get height(){return this.dims.y},set height(t){this.dims.y=t},get depth(){return this.dims.z},set depth(t){this.dims.z=t}},BBox.prototype.checkPoint=function(t){var e=this.pos.x+this.offsets.x,i=this.pos.y+this.offsets.y,r=this.pos.z+this.offsets.z,n=e-this.dims.x/2,o=e+this.dims.x/2,s=r-this.dims.z/2,a=r+this.dims.z/2,c=i-this.dims.y/2,u=i+this.dims.y/2;return t.x>=n&&t.x<=o&&t.z>=s&&t.z<=a&&t.y>=c&&t.y<=u?!0:!1},BBox.prototype.checkBBox=function(t){var e={occurred:!1},i=t.getPoints();for(var r in i)if(this.checkPoint(i[r]))return e.occurred=!0,e.normal=new Vector(0,0,1),e;return e},BBox.prototype.intersect=function(t){var e={occurred:!1},i=t.getPoints();for(var r in i)if(this.checkPoint(i[r]))return e.occurred=!0,e.normal=new Vector(0,0,1),e;i=this.getPoints();for(var r in i)if(t.checkPoint(i[r]))return e.occurred=!0,e.normal=new Vector(0,0,1),e;return e},BBox.prototype.getPoints=function(){var t=new Array,e=this.pos.add(this.offsets).add(this.dims.div(2));return t.push(e),e=this.pos.add(this.offsets).add(this.dims.div(-2)),t.push(e),e=this.pos.add(this.offsets).add(this.dims.div(new Vector(2,2,-2))),t.push(e),e=this.pos.add(this.offsets).add(this.dims.div(new Vector(-2,2,2))),t.push(e),e=this.pos.add(this.offsets).add(this.dims.div(new Vector(-2,2,-2))),t.push(e),e=this.pos.add(this.offsets).add(this.dims.div(new Vector(2,-2,2))),t.push(e),e=this.pos.add(this.offsets).add(this.dims.div(new Vector(-2,-2,2))),t.push(e),e=this.pos.add(this.offsets).add(this.dims.div(new Vector(2,-2,-2))),t.push(e),t},BRect.prototype=new BBox,BRect.prototype.checkPoint=function(t){var e=this.pos.x+this.offsets.x,i=this.pos.y+this.offsets.y,r=e,n=e+this.dims.x,o=i,s=i+this.dims.y;return t.x>=r&&t.x<=n&&t.y>=o&&t.y<=s?!0:!1},BRect.prototype.getPoints=function(){var t=new Array,e=this.pos.add(this.offsets);return t.push(e),e=this.pos.add(this.offsets).add(this.dims),t.push(e),e=this.pos.add(this.offsets).add(new Vector(this.dims.x,0,0)),t.push(e),e=this.pos.add(this.offsets).add(new Vector(0,this.dims.y,0)),t.push(e),t},CollisionGrid.prototype.reset=function(t,e,i,r,n,o){this.x=t,this.z=e,this.width=i,this.depth=r,this.cols=n,this.rows=o,this.size=n*o,this.cells=new Array;for(var s=0;s<this.size;s++)this.cells.push(new List)},CollisionGrid.prototype.insert=function(t){var e=t.x-this.x,i=t.z-this.z,r=Math.max(0,Math.min(this.cols-1,Math.floor(e/(this.width/this.cols)))),n=Math.max(0,Math.min(this.rows-1,Math.floor(i/(this.depth/this.rows))))*this.cols,o=Math.max(0,Math.min(this.size-1,r+n));this.cells[o].push(t)},CollisionGrid.prototype.clear=function(){for(var t in this.cells)this.cells[t]=new List},CollisionGrid.prototype.update=function(){},CollisionGrid.prototype.transform=function(){},CollisionGrid.prototype.unTransform=function(){},CollisionGrid.prototype.draw=function(){};var gInput=new Input;Input.prototype.blur=function(){for(var t=0;t<this.bools.length;t++)this.bools[t]=!1},Input.prototype.addBool=function(t,e){this.keys[t]=e,this.bools[e]=!1,Object.defineProperty(this,e,{get:function(){return this.bools[e]}})},Input.prototype.removeBool=function(t){delete this[t];for(var e in this.keys)if(this.keys[e]==t){this.keys[e]=null;break}},Input.prototype.addFunc=function(t,e,i){this.funcs[t]=e,this.repeats[t]=i},Input.prototype.removeFunc=function(t){for(var e in this.funcs)if(this.funcs[e]==t){this.funcs[e]=null,this.repeats[e]=!1;break}},Input.prototype.addLBtnFunc=function(t){this.lBtnFuncs.push(t)},Input.prototype.removeLBtnFunc=function(t){for(var e in this.lBtnFuncs)if(this.lBtnFuncs[e]==t){this.lBtnFuncs[e]=null;break}},Input.prototype.addMBtnFunc=function(t){this.mBtnFuncs.push(t)},Input.prototype.removeMBtnFunc=function(t){for(var e in this.mBtnFuncs)if(this.mBtnFuncs[e]==t){this.mBtnFuncs[e]=null;break}},Input.prototype.addRBtnFunc=function(t){this.rBtnFuncs.push(t)},Input.prototype.removeRBtnFunc=function(t){for(var e in this.rBtnFuncs)if(this.rBtnFuncs[e]==t){this.rBtnFuncs[e]=null;break}},Input.prototype.addMouseDownListener=function(t){this.mdListens.push(t)},Input.prototype.removeMouseDownListener=function(t){for(var e in this.mdListens)if(this.mdListens[e]==t){this.mdListens[e]=null;break}},Input.prototype.addMouseUpListener=function(t){this.muListens.push(t)},Input.prototype.removeMouseUpListener=function(t){for(var e in this.muListens)if(this.muListens[e]==t){this.muListens[e]=null;break}},Input.prototype.addMouseMoveListener=function(t){this.mmListens.push(t)},Input.prototype.removeMouseMoveListener=function(t){for(var e in this.mmListens)if(this.mmListens[e]==t){this.mmListens[e]=null;break}},Input.prototype.setMouse=function(t,e){this.mouse.x=t-canvas.offsetLeft,this.mouse.y=e-canvas.offsetTop,void 0!=display&&"relative"==display.style.position&&(this.mouse.x-=display.offsetLeft,this.mouse.y-=display.offsetTop),this.mouse.x/=canvas.scaleX,this.mouse.y/=canvas.scaleY},Input.prototype.addKeyboardListener=function(t){this.keyListens.push(t)},Input.prototype.removeMouseMoveListener=function(t){for(var e in this.keyListens)if(this.keyListens[e]==t){this.keyListens[e]=null;break}},Input.prototype.mouseMove=function(t){t||(t=window.event),this.setMouse(t.pageX,t.pageY);for(var e=0;e<this.mmListens.length;e++)this.mmListens[e].onMouseMove();return!1},Input.prototype.mouseDown=function(t){switch(t||(t=window.event),t.button){case 0:this.lBtn=!0;break;case 1:this.mBtn=!0;break;case 2:this.rBtn=!0}this.setMouse(t.pageX,t.pageY);for(var e=0;e<this.mdListens.length;e++)null!=this.mdListens[e]&&this.mdListens[e].onMouseDown(t.button);return!1},Input.prototype.mouseUp=function(t){switch(t||(t=window.event),t.button){case 0:this.lBtn=!1;for(var e=0;e<this.lBtnFuncs.length;e++)null!=this.lBtnFuncs[e]&&this.lBtnFuncs[e]();break;case 1:this.mBtn=!1;for(var e=0;e<this.mBtnFuncs.length;e++)null!=this.mBtnFuncs[e]&&this.mBtnFuncs[e]();break;case 2:this.rBtn=!1;for(var e=0;e<this.rBtnFuncs.length;e++)null!=this.rBtnFuncs[e]&&this.rBtnFuncs[e]()}this.setMouse(t.pageX,t.pageY);for(var i=0;i<this.muListens.length;i++)null!=this.muListens[i]&&this.muListens[i].onMouseUp(t.button);return!1},Input.prototype.handleKeyDown=function(t){var e=t.keyCode;this.printKey&&println("down: "+e),16==e&&(this.shift=!0),void 0!=this.keys[e]&&null!=this.keys[e]&&(this.bools[this.keys[e]]=!0),void 0!=this.funcs[e]&&null!=this.funcs[e]&&this.repeats[e]&&this.funcs[e]();for(var i=0;i<this.keyListens.length;i++)null!=this.keyListens[i]&&this.keyListens[i].onKeyDown(e);32==t.keyCode&&(t.preventDefault(),t.space=!0,this.handleKeyPress(t)),(8==t.keyCode||37==t.keyCode||38==t.keyCode||39==t.keyCode||40==t.keyCode)&&t.preventDefault()},Input.prototype.handleKeyUp=function(t){var e=t.keyCode;this.printKey&&println("up: "+e),16==e&&(this.shift=!1),void 0!=this.keys[e]&&null!=this.keys[e]&&(this.bools[this.keys[e]]=!1),void 0!=this.funcs[e]&&null!=this.funcs[e]&&(this.repeats[e]||this.funcs[e]())
},Input.prototype.handleKeyPress=function(t){var e=t.which;if(32==e&&!t.space)return!0;this.printKey&&println("press: "+e);for(var i=0;i<this.keyListens.length;i++)null!=this.keyListens[i]&&this.keyListens[i].onKeyPress(e);8==t.keyCode||32==t.keyCode},GUI.prototype=new Sprite,GUI.prototype.focus=null,GUI.prototype.onMouseDown=function(t){this.visible&&0==t&&(null!=this.focus&&(this.focus.focused=!1,this.focus.blur(),this.focus=null),this.children.foreach(this.childMouseDown,{gui:this,mouse:this.input.mouse.sub(this.pos)}))},GUI.prototype.childMouseDown=function(t,e){void 0!=t.onMouseDown&&t.bbox.checkPoint(e.mouse)&&(e.gui.focus=t,t.focused=!0,t.focus(),t.onMouseDown())},GUI.prototype.onMouseUp=function(t){this.visible&&0==t&&this.children.foreach(this.childMouseUp,{gui:this,mouse:this.input.mouse.sub(this.pos)})},GUI.prototype.childMouseUp=function(t,e){void 0!=t.onMouseUp&&(t.bbox.checkPoint(e.mouse)?t.onMouseUp():t.blur())},GUI.prototype.onMouseMove=function(){this.visible&&this.children.foreach(this.childMouseMove,{mouse:this.input.mouse.sub(this.pos)})},GUI.prototype.childMouseMove=function(t,e){void 0!=t.onMouseIn&&void 0!=t.onMouseOut&&(t.bbox.checkPoint(e.mouse)?t.onMouseIn():t.onMouseOut())},GUI.prototype.onKeyDown=function(t){this.visible&&null!=this.focus&&this.focus.onKeyDown&&this.focus.onKeyDown(t)},GUI.prototype.onKeyPress=function(t){this.visible&&null!=this.focus&&this.focus.onKeyPress&&this.focus.onKeyPress(t)},GUIElement.prototype=new Sprite,GUIElement.prototype.color="#000000",GUIElement.prototype.drawColor="#000000",GUIElement.prototype.dropShadow=!1,GUIElement.prototype.center=!1,GUIElement.prototype.focused=!1,GUIElement.prototype.mouseOver=!1,GUIElement.prototype.focus=function(){this.focused=!0},GUIElement.prototype.blur=function(){this.focused=!1},TextBox.prototype=new GUIElement,TextBox.prototype.text="",TextBox.prototype.textBuffer="",TextBox.prototype.minWidth=75,TextBox.prototype.fontSize=16,TextBox.prototype.font="Arial",TextBox.prototype.bgColor="#ffffff",TextBox.prototype.bgDrawColor="#ffffff",TextBox.prototype.bgFocusColor="#ccffcc",TextBox.prototype.borderColor="#000000",TextBox.prototype.borderDrawColor="#000000",TextBox.prototype.borderFocusColor="#ff0000",TextBox.prototype.drawBG=!1,TextBox.prototype.border=0,TextBox.prototype.padTop=2,TextBox.prototype.padLeft=2,TextBox.prototype.padRight=2,TextBox.prototype.padBottom=2,TextBox.prototype.editable=!1,TextBox.prototype.clearOnFocus=!1,TextBox.prototype.oldText="",TextBox.prototype.getDims=function(){this.bctx.font=this.fontSize+"px "+this.font,this.bctx.textBaseline="middle";var t=this.maxLineWidth(),e=this.numLines()*this.fontSize;return new Vector(Math.max(this.minWidth,t+this.padLeft+this.padRight),this.padTop+this.padBottom+e,0)},TextBox.prototype.maxLineWidth=function(){this.bctx.font=this.fontSize+"px "+this.font,this.bctx.textBaseline="middle";var t=(""+this.text).split("\n"),e=0;for(var i in t)i=t[i],e=Math.max(e,this.bctx.measureText(i).width);return e},TextBox.prototype.numLines=function(){var t=(""+this.text).split("\n");return t.length},TextBox.prototype.onMouseDown=function(){},TextBox.prototype.onMouseUp=function(){},TextBox.prototype.onMouseIn=function(){},TextBox.prototype.onMouseOut=function(){},TextBox.prototype.onKeyDown=function(t){8==t&&(this.text=this.text.substr(0,this.text.length-1))},TextBox.prototype.onKeyPress=function(t){var e=String.fromCharCode(t);8!=t&&(this.text+=e)},TextBox.prototype.focus=function(){this.focused=!0,this.clearOnFocus&&(this.minWidth=this.getDims().x,this.oldText=this.text,this.text="")},TextBox.prototype.blur=function(){this.focused=!1,this.clearOnFocus&&""==this.text&&(this.text=this.oldText)},TextBox.prototype.redraw=function(t){this.buffer.width=t.x,this.buffer.height=t.y;var e=this.bctx;e.font=this.fontSize+"px "+this.font,e.textBaseline="middle";var i=e.measureText(this.text).width;this.width=t.x,this.height=t.y;var r=0,n=0,o=0;this.center&&(r=-(i+this.padLeft+this.padRight)/2,n=-t.x/2,o=-t.y/2,this.xoffset=-t.x/2,this.yoffset=-t.y/2),this.editable&&this.focused?(this.bgDrawColor=this.bgFocusColor,this.borderDrawColor=this.borderFocusColor):(this.bgDrawColor=this.bgColor,this.borderDrawColor=this.borderColor),this.drawBG&&(e.fillStyle=this.bgDrawColor,e.fillRect(0,0,t.x,t.y)),this.border>0&&(e.lineWidth=this.border,e.strokeStyle=this.borderDrawColor,e.strokeRect(0,0,t.x,t.y),e.lineWidth=1),this.dropShadow&&(e.shadowBlur=3,e.shadowColor="#000000"),e.fillStyle=this.color;for(var s=(""+this.text).split("\n"),r=this.padLeft,a=this.padTop+.5*this.fontSize,c=0;c<s.length;c++){var u=s[c];this.center&&(r=(t.x-e.measureText(u).width)/2),e.fillText(u,r,a+this.fontSize*c)}e.shadowBlur=0,this.image=this.buffer,Textures.createTexture(this.image)},TextBox.prototype.draw=function(t){var e=this.getDims(),i=0,r=0;this.center&&(i=-e.x/2,r=-e.y/2),this.bbox.pos.x=this.x+i,this.bbox.pos.y=this.y+r,this.bbox.dims.x=e.x,this.bbox.dims.y=e.y,(this.text!=this.textBuffer||e.x!=this.bufferDimX||this.color!=this.bufferColor)&&(this.redraw(e),this.textBuffer=this.text,this.bufferDimX=e.x,this.bufferColor=this.color),Sprite.prototype.draw.call(this,t)},Button.prototype=new GUIElement,Button.prototype.onMouseDown=function(){this.drawColor=this.downColor},Button.prototype.onMouseUp=function(){this.drawColor=this.upColor,this.focused&&void 0!=this.func&&this.func(),this.blur()},Button.prototype.onMouseIn=function(){this.mouseOver=!0,this.focused||(this.drawColor=this.upColor)},Button.prototype.onMouseOut=function(){this.mouseOver=!1,this.drawColor=this.color},Button.prototype.update=function(){},Button.prototype.draw=function(t){var e=0,i=0;this.center&&(e=-this.width/2,i=-this.height/2),this.bbox.pos.x=this.x+e,this.bbox.pos.y=this.y+i,this.bbox.dims.x=this.width,this.bbox.dims.y=this.height,this.dropShadow&&(t.shadowBlur=3,t.shadowColor="#000000"),t.fillStyle=this.drawColor,!this.drawBG||!use2D||void 0!=this.image.loaded&&this.image.loaded||t.fillRect(e,i,this.width,this.height),t.shadowBlur=0,Sprite.prototype.draw.call(this,ctx)},TextButton.prototype=new Button,TextButton.prototype.setLabelColors=function(t,e,i){this.labelColor=t,this.labelUpColor=e,this.labelDownColor=i,this.labelDrawColor=t,this.label.color=t},TextButton.prototype.onMouseDown=function(){this.label.color=this.labelDownColor,Button.prototype.onMouseDown.call(this)},TextButton.prototype.onMouseUp=function(){this.label.color=this.labelUpColor,Button.prototype.onMouseUp.call(this)},TextButton.prototype.onMouseIn=function(){this.focused||(this.label.color=this.labelUpColor),Button.prototype.onMouseIn.call(this)},TextButton.prototype.onMouseOut=function(){this.label.color=this.labelColor,Button.prototype.onMouseOut.call(this)},TextButton.prototype.draw=function(t){this.center&&(this.label.center=!0),this.width=this.label.getDims().x,this.height=this.label.getDims().y,Button.prototype.draw.call(this,t)};var gameLoop,oldTime,MSPF=17,FPS=60,canvas,aspectRatio,ctx,matrixStack=new List,clearColor=[1,1,1,1],effects=new PostFXChain,log=new List,showConsole=!1,use2D=getCookie("use2D")?"true"==getCookie("use2D"):!1,brineConsole,useViewCulling=!0,allowContextMenu=!0,useStates=!1,world=new Sprite;world.init=function(){};var display,brinePixelData="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkZDRjI0RUYxRDdDNTExRTFBRkJCQzk5NTUyMDgzMDVDIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkZDRjI0RUYyRDdDNTExRTFBRkJCQzk5NTUyMDgzMDVDIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6RkNGMjRFRUZEN0M1MTFFMUFGQkJDOTk1NTIwODMwNUMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6RkNGMjRFRjBEN0M1MTFFMUFGQkJDOTk1NTIwODMwNUMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7FSUX/AAAAD0lEQVR42mL4//8/QIABAAX+Av4tzonuAAAAAElFTkSuQmCC";Textures.load(brinePixelData),function(){for(var t=0,e=["ms","moz","webkit","o"],i=0;i<e.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[e[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[i]+"CancelAnimationFrame"]||window[e[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e){var i=(new Date).getTime(),r=Math.max(0,16-(i-t)),n=window.setTimeout(function(){e(i+r)},r);return t=i+r,n}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}();
